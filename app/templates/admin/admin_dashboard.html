{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Admin Dashboard</h2>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4 mb-lg-0"><div class="card h-100"><div class="card-body">
            <h5 class="card-title">Service Requests by Status</h5><canvas id="requestsChart"></canvas>
        </div></div></div>
        <div class="col-lg-6"><div class="card h-100"><div class="card-body">
            <h5 class="card-title">Ratings Distribution</h5><canvas id="ratingsChart"></canvas>
        </div></div></div>
    </div>

    <!-- Action Required: Rejected Requests -->
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white"><h4 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Action Required</h4></div>
        <div class="card-body">
            {% if rejected_requests %}
            <div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>ID</th><th>Customer</th><th>Service</th><th>Professional</th><th>Date Requested</th><th class="text-end">Base Price</th><th class="text-end">Proposed Price</th><th>Action</th></tr></thead>
                <tbody>{% for req in rejected_requests %}
                    <tr>
                        <td>#{{ req.id }}</td><td>{{ req.customer.user.username }}</td><td>{{ req.service.service_type }}</td><td>{{ req.professional.user.username if req.professional else 'N/A' }}</td>
                        <td>{{ req.date_of_request.strftime('%Y-%m-%d') }}</td><td class="text-end">${{ "%.2f"|format(req.service.base_price) }}</td><td class="text-end">${{ "%.2f"|format(req.proposed_price) }}</td>
                        <td><button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#reassignModal{{ req.id }}">Reassign</button></td>
                    </tr>
                {% endfor %}</tbody>
            </table></div>
            {% else %}<p class="text-center text-muted">No rejected requests require action.</p>{% endif %}
        </div>
    </div>
    <!-- MODALS for Rejected Requests (OUTSIDE the table) -->
    {% for req in rejected_requests %}
    <div class="modal fade" id="reassignModal{{ req.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <form method="POST" action="{{ url_for('admin.reassign_professional', request_id=req.id) }}">
            <div class="modal-header"><h5 class="modal-title">Reassign Request #{{ req.id }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p>Select a new professional for <strong>{{ req.service.service_type }}</strong>.</p>
                <select name="professional_id" class="form-select" required>
                    <option value="">-- Select --</option>
                    {% for prof in professionals if prof.service_id == req.service_id and prof.is_verified and not prof.admin_blocked %}<option value="{{ prof.id }}">{{ prof.user.username }}</option>{% endfor %}
                </select>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Confirm</button></div>
        </form>
    </div></div></div>
    {% endfor %}

    <!-- Service Management -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center"><h4 class="mb-0">Services</h4><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createServiceModal"><i class="fas fa-plus me-2"></i>Add Service</button></div>
        <div class="card-body">
            <div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Base Price</th><th class="text-center">Actions</th></tr></thead>
                <tbody>{% for service in services %}
                    <tr>
                        <td>{{ service.id }}</td><td>{{ service.service_type }}</td><td>{{ service.description }}</td><td>${{ "%.2f"|format(service.base_price) }}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#editServiceModal{{ service.id }}" title="Edit"><i class="fas fa-edit action-icon icon-edit"></i></button>
                            <form action="{{ url_for('admin.delete_service', service_id=service.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete?');"><button type="submit" class="btn btn-link p-0" title="Delete"><i class="fas fa-trash-alt action-icon icon-delete"></i></button></form>
                        </td>
                    </tr>
                {% endfor %}</tbody>
            </table></div>
        </div>
    </div>
    <!-- MODALS for Services (OUTSIDE the table) -->
    <div class="modal fade" id="createServiceModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <form action="{{ url_for('admin.create_service') }}" method="POST">
            <div class="modal-header"><h5 class="modal-title">Create New Service</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label">Name</label><input type="text" name="service_type" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Base Price</label><input type="number" step="0.01" name="base_price" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3"></textarea></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Create</button></div>
        </form>
    </div></div></div>
    {% for service in services %}
    <div class="modal fade" id="editServiceModal{{ service.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <form action="{{ url_for('admin.update_service', service_id=service.id) }}" method="POST">
            <div class="modal-header"><h5 class="modal-title">Edit: {{ service.service_type }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label">Name</label><input type="text" name="service_type" class="form-control" value="{{ service.service_type }}" required></div>
                <div class="mb-3"><label class="form-label">Base Price</label><input type="number" step="0.01" name="base_price" class="form-control" value="{{ service.base_price }}" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3">{{ service.description or '' }}</textarea></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div></div>
    {% endfor %}

    <!-- Other Management Tables (Tabs) -->
    <div class="card">
        <div class="card-header"><ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#professionals" type="button" role="tab">Professionals</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab">Customers</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#all-requests" type="button" role="tab">All Requests</button></li>
        </ul></div>
        <div class="card-body tab-content">
            <div class="tab-pane fade show active" id="professionals" role="tabpanel"><div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>Username</th><th>Service</th><th>Description</th><th>Yr of Exp</th><th>Address</th><th>Pin</th><th>Status</th><th class="text-center">Action</th></tr></thead>
                <tbody>{% for prof in professionals %}
                    <tr>
                        <td>
                        <a href="{{ url_for('shared.professional_profile', professional_id=prof.id) }}" class="text-decoration-none">
                            {{ prof.user.username }}
                        </a></td><td>{{ prof.service.service_type }}</td><td>{{ prof.description or 'N/A' }}</td><td>{{ prof.experience or 'N/A' }}</td><td>{{ prof.user.address or 'N/A' }}</td><td>{{ prof.user.pin or 'N/A' }}</td>
                        <td>{% if prof.is_verified %}<span class="badge bg-success">Verified</span>{% elif prof.verification_failed %}<span class="badge bg-danger">Rejected</span>{% else %}<span class="badge bg-warning text-dark">Pending</span>{% endif %}</td>
                        <td class="text-center">
                            {% if not prof.is_verified and not prof.verification_failed %}
                                <form action="{{ url_for('admin.approve_professional', professional_id=prof.id) }}" method="POST" class="d-inline" title="Approve"><button type="submit" class="btn btn-link p-0"><i class="fas fa-check-circle action-icon icon-approve"></i></button></form>
                                <form action="{{ url_for('admin.reject_professional', professional_id=prof.id) }}" method="POST" class="d-inline" title="Reject"><button type="submit" class="btn btn-link p-0"><i class="fas fa-times-circle action-icon icon-reject"></i></button></form>
                            {% endif %}
                            {% if prof.admin_blocked %}<form action="{{ url_for('admin.unblock_user', user_id=prof.user.id) }}" method="POST" class="d-inline" title="Unblock"><button type="submit" class="btn btn-link p-0"><i class="fas fa-unlock action-icon icon-unblock"></i></button></form>
                            {% else %}<form action="{{ url_for('admin.block_user', user_id=prof.user.id) }}" method="POST" class="d-inline" title="Block"><button type="submit" class="btn btn-link p-0"><i class="fas fa-ban action-icon icon-block"></i></button></form>{% endif %}
                        </td>
                    </tr>
                {% endfor %}</tbody>
            </table></div></div>
            <div class="tab-pane fade" id="customers" role="tabpanel"><div class="table-responsive"><table class="table table-hover">
                 <thead><tr><th>Username</th><th>Email</th><th>Address</th><th>Pin</th><th>Status</th><th class="text-center">Actions</th></tr></thead>
                <tbody>{% for cust in customers %}
                    <tr>
                        <td>
                        <a href="{{ url_for('customer.customer_profile', customer_id=cust.id) }}" class="text-decoration-none">
                            {{ cust.user.username }}
                        </a></td><td>{{ cust.user.email }}</td><td>{{ cust.user.address }}</td><td>{{ cust.user.pin }}</td>
                        <td>{% if cust.admin_blocked %}<span class="badge bg-danger">Blocked</span>{% else %}<span class="badge bg-success">Active</span>{% endif %}</td>
                        <td class="text-center">
                            {% if cust.admin_blocked %}<form action="{{ url_for('admin.unblock_user', user_id=cust.user.id) }}" method="POST" class="d-inline" title="Unblock"><button type="submit" class="btn btn-link p-0"><i class="fas fa-unlock action-icon icon-unblock"></i></button></form>
                            {% else %}<form action="{{ url_for('admin.block_user', user_id=cust.user.id) }}" method="POST" class="d-inline" title="Block"><button type="submit" class="btn btn-link p-0"><i class="fas fa-ban action-icon icon-block"></i></button></form>{% endif %}
                        </td>
                    </tr>
                {% endfor %}</tbody>
            </table></div></div>
            <div class="tab-pane fade" id="all-requests" role="tabpanel"><div class="table-responsive"><table class="table table-hover">
                <thead>
                <tr>
                    <!-- Headers Updated for more detail -->
                    <th>ID</th>
                    <th>Customer</th>
                    <th>Service</th>
                    <th>Professional</th>
                    <th>Date Requested</th>
                    <th class="text-end">Base Price</th>
                    <th class="text-end">Proposed Price</th>
                    <th>Status</th>
                    <th>Date Completed</th></tr></thead>
              <tbody>
                {% for req in all_requests %}
                <tr>
                    <!-- Data cells now match the new headers -->
                    <td>#{{ req.id }}</td>
                    <td>{{ req.customer.user.username }}</td>
                    <td>{{ req.service.service_type }}</td>
                    <td>{{ req.professional.user.username if req.professional else 'N/A' }}</td>
                    <td>{{ req.date_of_request.strftime('%Y-%m-%d') }}</td>
                    <td class="text-end">${{ "%.2f"|format(req.service.base_price) }}</td>
                    <td class="text-end">${{ "%.2f"|format(req.proposed_price) }}</td>
                    <td>
                        <span class="badge 
                            {% if req.service_status.name == 'REQUESTED' %} bg-warning text-dark
                            {% elif req.service_status.name == 'ACCEPTED' %} bg-info
                            {% elif req.service_status.name == 'CLOSED' %} bg-secondary
                            {% elif req.service_status.name == 'REJECTED' %} bg-danger
                            {% elif req.service_status.name == 'PAID' %} bg-success
                            {% endif %}">
                            {{ req.service_status.name.title() }}
                        </span>
                    </td>
                    <td>{{ req.date_of_completion.strftime('%Y-%m-%d') if req.date_of_completion else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
            </table></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Chart.js script
    document.addEventListener('DOMContentLoaded', function () {
        fetch("{{ url_for('admin.admin_chart_data') }}")
            .then(response => response.json()).then(data => {
                const requestsCtx = document.getElementById('requestsChart').getContext('2d');
                new Chart(requestsCtx, { type: 'bar', data: { labels: data.requests_by_status.labels, datasets: [{ label: '# of Requests', data: data.requests_by_status.data, backgroundColor: ['rgba(255, 206, 86, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)'], borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
                const ratingsCtx = document.getElementById('ratingsChart').getContext('2d');
                new Chart(ratingsCtx, { type: 'pie', data: { labels: data.ratings_distribution.labels, datasets: [{ label: 'Ratings', data: data.ratings_distribution.data, hoverOffset: 4 }] } });
            }).catch(error => console.error('Error fetching chart data:', error));
    });
</script>
{% endblock %}